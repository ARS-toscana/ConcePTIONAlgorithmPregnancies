---
title: "Verification report"
output: 
  html_document:
    theme: united
    toc: TRUE
    toc_float: TRUE
date: ""
---

```{css, echo = FALSE}
h1 {color: #ed008c}
h2 {color: #00adef}
h3 {color: #6ccff6}
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {background-color: #00adef; border-color: #00adef}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

rm(list=ls(all.names=TRUE))

#set the directories
if (!require("rstudioapi")) install.packages("rstudioapi")
thisdir<-setwd(dirname(rstudioapi::getSourceEditorContext()$path))
thisdir<-setwd(dirname(rstudioapi::getSourceEditorContext()$path))
setwd(thisdir)


# libraries 
if (!require("haven")) install.packages("haven")
library(haven)
if (!require("tidyverse")) install.packages("tidyverse")
library(dplyr)
if (!require("lubridate")) install.packages("lubridate")
library(lubridate)
if (!require("data.table")) install.packages("data.table")
library(data.table)
if (!require("stringr")) install.packages("stringr")
library(stringr)
if (!require("purrr")) install.packages("purrr")
library(purrr)
if (!require("readr")) install.packages("readr")
library(readr)
if (!require("dplyr")) install.packages("dplyr")
library(dplyr)
if (!require("survival")) install.packages("survival")
library(survival)
if (!require("rmarkdown")) install.packages("rmarkdown")
library(rmarkdown )
if (!require("ggplot2")) install.packages("ggplot2")
library(ggplot2 )
if (!require("ggthemes")) install.packages("ggthemes")
library(ggthemes)
if (!require("ggrepel")) install.packages("ggrepel")
library(ggrepel)
if (!require("plotly")) install.packages("plotly")
library(plotly)
if (!require("DT")) install.packages("DT")
library(DT)
if (!require("magrittr")) install.packages("magrittr")
library(magrittr)
if (!require("multipanelfigure")) install.packages("multipanelfigure")
library(multipanelfigure)

`%notin%` <- Negate(`%in%`)

sample_validated = params$sample_validated
```



## Record concordance

For each pregnancy, start, end, and type of end are defined by information obtained from multiple records retrieved from different sources. When records carry different information, the algorithm selects the highest quality (in accordance with the hierarchy) and saves the results of the process.
Records of the same pregnancy can be:

- concordant: equal start and end dates;

- slightly discordant: start and end date different by no more than 7 days;

- discordant: start and end date different more than 7 days (GGDE and GGDS are green record discordant respectively on end date and start date);

- inconsistent: when a red record is not included between the beginning and the end of the pregnancy.

In addition a pregnancy can be compose only of low quality record (red or blue record), in this case the pregnancy will be classified as INSUF_QUALITY.

The next graph shows the percentage of pregnancies that have non-concordant records (or are composed only of low quality records). The same pregnancy can be composed of concordant, discordant and inconsistent records, so the same pregnancy can be counted in multiple columns.




```{r reconciliation}
# hierarchy
# 1. GG_discordant_end
# 2. GG_discordant_start
# 3. Discordant
# 4- SlightlyDiscordant

# Inconsistency
# StartUpdated
# InsuffQuality
# pregnancy splitted

for (DAP in list_of_DAPs) {
  tmp <- get(paste0(DAP, "_reconcil"))
  tmp[N == "<5", N := 0][, N := as.integer(N)]
  
  list_of_var <- names(tmp)[names(tmp) %notin% c("type_of_pregnancy_end", "N", "pregnancy_splitted")]
  string_cond <- paste0(list_of_var, " == 0 ", collapse = ' & ')
  tmp <- tmp[eval(parse(text = string_cond)), Concordant := 1][is.na(Concordant), Concordant := 0]
  list_of_var_2 <- c(list_of_var, 'Concordant')
  tmp <- tmp[, tot := sum(N)][, percentage := round((N/tot)*100, 4)]
  
  total_n_of_pregnancy <- tmp[, sum(N)]
  
  
  list_of_DT_vars <- vector(mode = 'list')
  for (var in list_of_var_2) {
    tmp2 <- tmp[get(var) == 1][, `:=` (Variable = var)]
    tmp2 <- tmp2[, sum(N), .(type_of_pregnancy_end, Variable)]
    list_of_DT_vars[[var]] <- tmp2
  }
  
  tmp3 <- rbindlist(list_of_DT_vars)
  setnames(tmp3, "V1", "N")
  tmp3_type <- tmp3[, tot :=  total_n_of_pregnancy][, percentage := round((N/tot)*100, 4)]
  tmp3_agg <- tmp3[, sum(N), Variable]
  setnames(tmp3_agg, "V1", "N")
  tmp3_agg <- tmp3_agg[, tot :=  total_n_of_pregnancy][, percentage := round((N/tot)*100, 4)]
  
  assign(paste0("DT_plt_", DAP), tmp3_type)
}
#DT_recon[percentage == "0", percentage := "< 0.05"]
```
```{r DT_plt_ARS_agg_type}
# DT_plt_ARS <- DT_plt_ARS[type_of_pregnancy_end == "ONGOING", type_of_pregnancy_end := "ONG"]
# 
# plt <- ggplot(DT_plt_ARS[Variable != "Concordant"], aes(x = Variable, y =percentage, fill= type_of_pregnancy_end)) +
#   geom_col()+
#   #guides(fill = guide_legend(title = "Type of end")) +
#   xlab("")+
#   ylab("")+
#   labs(fill = "Type of end") +
#   theme_bw()+
#   theme(text = element_text(family = "serif"), axis.text.x = element_text(angle = 45))
# 
# plt <- ggplotly(plt)
# plt
```





```{r DT_plt_ARS_agg}
plt <- ggplot(tmp3_agg[Variable != "Concordant"], aes(x = Variable, y =percentage)) +
  geom_col(fill = "salmon")+
  guides(fill = guide_legend(title = "")) +
  xlab("")+
  ylab("")+
  theme_bw()+
  theme(text = element_text(family = "serif"))

plt <- ggplotly(plt)
plt
```



The following graph shows for each concordance variables the proportion of type of end.

```{r DT_plt_ARS_agg_type_perc, warning=FALSE}
DT_plt_ARS <- DT_plt_ARS[type_of_pregnancy_end == "ONGOING", type_of_pregnancy_end := "ONG"]
DT_plt_ARS_tot_var <- DT_plt_ARS[, tot_var := sum(N), Variable]
DT_plt_ARS_tot_var <- DT_plt_ARS_tot_var[, prop := N/tot_var]


plt <- ggplot(DT_plt_ARS[Variable != "Concordant"], aes(x = Variable, y =prop, fill= type_of_pregnancy_end)) +
  geom_col()+
  #guides(fill = guide_legend(title = "Type of end")) +
  xlab("")+
  ylab("")+
  labs(fill = "Type of end") +
  theme_bw()+
  theme(text = element_text(family = "serif"), axis.text.x = element_text(angle = 45))

plt <- ggplotly(plt)
plt
```


```{r DT_plt_ARS}
# DT_plt_ARS <- DT_plt_ARS[type_of_pregnancy_end == "ONGOING", type_of_pregnancy_end := "ONG"]
# 
# plt <- ggplot(DT_plt_ARS[Variable != "Concordant"], aes(x = type_of_pregnancy_end, y =percentage, fill = type_of_pregnancy_end)) +
#   geom_col()+
#   guides(fill = guide_legend(title = "")) +
#   xlab("")+
#   ylab("")+
#   facet_wrap(. ~ Variable)+
#   theme_bw()+
#   theme(text = element_text(family = "serif"))
# 
# plt <- ggplotly(plt)
# plt
```






## Validation results

This section contains the results of the validation.

---

<br>

### GGDE


```{r valid_res_1}
if("GGDE" %in% names(ARS_reconcil)){
  ntmp <- ARS_reconcil[GGDE == 1, sum(N)]
  ntmp_validated <- ARS_valid[sample == "GG:DiscordantEnd", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " have discordant green records on the end." )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) with discordant green records on the end date on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`



```{r valid_res_2}
if(ntmp_validated >= 5){
  DT_GGDE <- ARS_valid[sample == "GG:DiscordantEnd"][, .(pregnancy_id, pregnancy_start_date_correct, pregnancy_end_date_correct, type_of_pregnancy_end_correct, records_belong_to_multiple_pregnancy, comments)]
  DT_GGDE <- DT_GGDE[(tolower(pregnancy_start_date_correct)  == "yes" | tolower(pregnancy_start_date_correct)  == "y") &
                        (tolower(pregnancy_end_date_correct)    == "yes" | tolower(pregnancy_end_date_correct)    == "y") &
                        (tolower(type_of_pregnancy_end_correct) == "yes" | tolower(type_of_pregnancy_end_correct) == "y") &
                        (tolower(records_belong_to_multiple_pregnancy) == "no"  | tolower(records_belong_to_multiple_pregnancy) == "n"), 
                       accepted := TRUE][is.na(accepted), accepted := FALSE]
    

  paged_table(DT_GGDE)
}


```


`r {DT_GGDE[accepted == TRUE, .N]}` pregnancy on `r {ntmp_validated}` are correctly classified according to validators. 




---

<br>

### GGDS


```{r valid_res_3}
if("GGDS" %in% names(ARS_reconcil)){
  ntmp <- ARS_reconcil[GGDE == 1, sum(N)]
  ntmp_validated <- ARS_valid[sample == "GG:DiscordantStart", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " have discordant green records on the start" )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) with discordant green records on the start date on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`



```{r valid_res_4}
if(ntmp_validated >= 5){
  DT_GGDS <- ARS_valid[sample == "GG:DiscordantStart"][, .(pregnancy_id, pregnancy_start_date_correct, pregnancy_end_date_correct, type_of_pregnancy_end_correct, records_belong_to_multiple_pregnancy, comments)]
  DT_GGDS <- DT_GGDS[(tolower(pregnancy_start_date_correct)  == "yes" | tolower(pregnancy_start_date_correct)  == "y") &
                        (tolower(pregnancy_end_date_correct)    == "yes" | tolower(pregnancy_end_date_correct)    == "y") &
                        (tolower(type_of_pregnancy_end_correct) == "yes" | tolower(type_of_pregnancy_end_correct) == "y") &
                        (tolower(records_belong_to_multiple_pregnancy) == "no"  | tolower(records_belong_to_multiple_pregnancy) == "n"), 
                       accepted := TRUE][is.na(accepted), accepted := FALSE]
    

  paged_table(DT_GGDS)
}


```


`r {DT_GGDS[accepted == TRUE, .N]}` pregnancy on `r {ntmp_validated}` are correctly classified according to validators. 



---

<br>

### Discordant


```{r valid_res_5}
if("Discordant" %in% names(ARS_reconcil)){
  ntmp <- ARS_reconcil[GGDE == 1, sum(N)]
  ntmp_validated <- ARS_valid[sample == "Discordant", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " have discordant records on the end." )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) with discordant records on the end date on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`



```{r valid_res_6}
if(ntmp_validated >= 5){
  DT_Discordant <- ARS_valid[sample == "Discordant"][, .(pregnancy_id, pregnancy_start_date_correct, pregnancy_end_date_correct, type_of_pregnancy_end_correct, records_belong_to_multiple_pregnancy, comments)]
  DT_Discordant <- DT_Discordant[(tolower(pregnancy_start_date_correct)  == "yes" | tolower(pregnancy_start_date_correct)  == "y") &
                        (tolower(pregnancy_end_date_correct)    == "yes" | tolower(pregnancy_end_date_correct)    == "y") &
                        (tolower(type_of_pregnancy_end_correct) == "yes" | tolower(type_of_pregnancy_end_correct) == "y") &
                        (tolower(records_belong_to_multiple_pregnancy) == "no"  | tolower(records_belong_to_multiple_pregnancy) == "n"), 
                       accepted := TRUE][is.na(accepted), accepted := FALSE]
    

  paged_table(DT_Discordant)
}


```


`r {DT_Discordant[accepted == TRUE, .N]}` pregnancy on `r {ntmp_validated}` are correctly classified according to validators. 



---

<br>

### SlightlyDiscordant


```{r valid_res_7}
if("SlightlyDiscordant" %in% names(ARS_reconcil)){
  ntmp <- ARS_reconcil[GGDE == 1, sum(N)]
  ntmp_validated <- ARS_valid[sample == "SlightlyDiscordant", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " have slightly discordant records on the end." )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) with slightly discordant records on the end date on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`



```{r valid_res_8}
if(ntmp_validated >= 5){
  DT_SlightlyDiscordant <- ARS_valid[sample == "SlightlyDiscordant"][, .(pregnancy_id, pregnancy_start_date_correct, pregnancy_end_date_correct, type_of_pregnancy_end_correct, records_belong_to_multiple_pregnancy, comments)]
  DT_SlightlyDiscordant <- DT_SlightlyDiscordant[(tolower(pregnancy_start_date_correct)  == "yes" | tolower(pregnancy_start_date_correct)  == "y") &
                        (tolower(pregnancy_end_date_correct)    == "yes" | tolower(pregnancy_end_date_correct)    == "y") &
                        (tolower(type_of_pregnancy_end_correct) == "yes" | tolower(type_of_pregnancy_end_correct) == "y") &
                        (tolower(records_belong_to_multiple_pregnancy) == "no"  | tolower(records_belong_to_multiple_pregnancy) == "n"), 
                       accepted := TRUE][is.na(accepted), accepted := FALSE]
    

  paged_table(DT_SlightlyDiscordant)
}


```


`r {DT_SlightlyDiscordant[accepted == TRUE, .N]}` pregnancy on `r {ntmp_validated}` are correctly classified according to validators. 



---

<br>

### Inconsistency


```{r valid_res_9}
if("Inconsistency" %in% names(ARS_reconcil)){
  ntmp <- ARS_reconcil[Inconsistency == 1, sum(N)]
  ntmp_validated <- ARS_valid[sample == "Inconsistency", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " have inconcistent records" )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) with inconcistent records on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`



```{r valid_res_10}
if(ntmp_validated >= 5){
  DT_Inconsistency <- ARS_valid[sample == "Inconsistency"][, .(pregnancy_id, pregnancy_start_date_correct, pregnancy_end_date_correct, type_of_pregnancy_end_correct, records_belong_to_multiple_pregnancy, comments)]
  DT_Inconsistency <- DT_Inconsistency[(tolower(pregnancy_start_date_correct)  == "yes" | tolower(pregnancy_start_date_correct)  == "y") &
                        (tolower(pregnancy_end_date_correct)    == "yes" | tolower(pregnancy_end_date_correct)    == "y") &
                        (tolower(type_of_pregnancy_end_correct) == "yes" | tolower(type_of_pregnancy_end_correct) == "y") &
                        (tolower(records_belong_to_multiple_pregnancy) == "no"  | tolower(records_belong_to_multiple_pregnancy) == "n"), 
                       accepted := TRUE][is.na(accepted), accepted := FALSE]
    

  paged_table(DT_Inconsistency)
}


```


`r {DT_Inconsistency[accepted == TRUE, .N]}` pregnancy on `r {ntmp_validated}` are correctly classified according to validators. 



---

<br>

### StartUpdated


```{r valid_res_11}
if("StartUpdated" %in% names(ARS_reconcil)){
  ntmp <- ARS_reconcil[GGDE == 1, sum(N)]
  ntmp_validated <- ARS_valid[sample == "StartUpdated", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " have the start of pregnancy updated from a blue record." )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) with the start of pregnancy updated from a blue record on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`



```{r valid_res_12}
if(ntmp_validated >= 5){
  DT_StartUpdated <- ARS_valid[sample == "StartUpdated"][, .(pregnancy_id, pregnancy_start_date_correct, pregnancy_end_date_correct, type_of_pregnancy_end_correct, records_belong_to_multiple_pregnancy, comments)]
  DT_StartUpdated <- DT_StartUpdated[(tolower(pregnancy_start_date_correct)  == "yes" | tolower(pregnancy_start_date_correct)  == "y") &
                        (tolower(pregnancy_end_date_correct)    == "yes" | tolower(pregnancy_end_date_correct)    == "y") &
                        (tolower(type_of_pregnancy_end_correct) == "yes" | tolower(type_of_pregnancy_end_correct) == "y") &
                        (tolower(records_belong_to_multiple_pregnancy) == "no"  | tolower(records_belong_to_multiple_pregnancy) == "n"), 
                       accepted := TRUE][is.na(accepted), accepted := FALSE]
    

  paged_table(DT_StartUpdated)
}


```


`r {DT_StartUpdated[accepted == TRUE, .N]}` pregnancy on `r {ntmp_validated}` are correctly classified according to validators. 


---

<br>

### INSUF_QUALITY


```{r valid_res_13}
if("INSUF_QUALITY" %in% names(ARS_reconcil)){
  ntmp <- ARS_reconcil[INSUF_QUALITY == 1, sum(N)]
  ntmp_validated <- ARS_valid[sample == "insufficient_quality", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " are only composed of low quality record." )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) only composed of low quality record on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`



```{r valid_res_14}
if(ntmp_validated >= 5){
  DT_INSUF_QUALITY <- ARS_valid[sample == "insufficient_quality"][, .(pregnancy_id, pregnancy_start_date_correct, pregnancy_end_date_correct, type_of_pregnancy_end_correct, records_belong_to_multiple_pregnancy, comments)]
  DT_INSUF_QUALITY <- DT_INSUF_QUALITY[(tolower(pregnancy_start_date_correct)  == "yes" | tolower(pregnancy_start_date_correct)  == "y") &
                        (tolower(pregnancy_end_date_correct)    == "yes" | tolower(pregnancy_end_date_correct)    == "y") &
                        (tolower(type_of_pregnancy_end_correct) == "yes" | tolower(type_of_pregnancy_end_correct) == "y") &
                        (tolower(records_belong_to_multiple_pregnancy) == "no"  | tolower(records_belong_to_multiple_pregnancy) == "n"), 
                       accepted := TRUE][is.na(accepted), accepted := FALSE]
    

  paged_table(DT_INSUF_QUALITY)
}


```


`r {DT_INSUF_QUALITY[accepted == TRUE, .N]}` pregnancy on `r {ntmp_validated}` are correctly classified according to validators. 




---

<br>

### Random sample


```{r valid_res_15}
ntmp_validated <- ARS_valid[sample == "All", .N]

if(ntmp_validated >= 5){
  talk <- paste0(ntmp_validated, " pregnancies are ramndomply extracted and validated.")
}

```

`r {talk}`



```{r valid_res_16}
if(ntmp_validated >= 5){
  DT_All <- ARS_valid[sample == "All"][, .(pregnancy_id, pregnancy_start_date_correct, pregnancy_end_date_correct, type_of_pregnancy_end_correct, records_belong_to_multiple_pregnancy, comments)]
  DT_All <- DT_All[(tolower(pregnancy_start_date_correct)  == "yes" | tolower(pregnancy_start_date_correct)  == "y") &
                        (tolower(pregnancy_end_date_correct)    == "yes" | tolower(pregnancy_end_date_correct)    == "y") &
                        (tolower(type_of_pregnancy_end_correct) == "yes" | tolower(type_of_pregnancy_end_correct) == "y") &
                        (tolower(records_belong_to_multiple_pregnancy) == "no"  | tolower(records_belong_to_multiple_pregnancy) == "n"), 
                       accepted := TRUE][is.na(accepted), accepted := FALSE]
    

  paged_table(DT_All)
}


```


`r {DT_All[accepted == TRUE, .N]}` pregnancy on `r {ntmp_validated}` are correctly classified according to validators. 




<br>
<br>
<br>

## Expected pregnancies 

#### total
```{r valid_res_17}
DT_All <- data.table(variable = c("GGDE", 
                                  "GGDS",
                                  "Discordant",
                                  "SlightlyDiscordant",
                                  "Inconsistency",
                                  "StartUpdated",
                                  "INSUF_QUALITY",
                                  "Random"), 
                     
                     N = c(ARS_reconcil[GGDE == 1, sum(N)],
                           ARS_reconcil[GGDS == 1, sum(N)],
                           ARS_reconcil[Discordant == 1, sum(N)],
                           ARS_reconcil[SlightlyDiscordant == 1, sum(N)],
                           ARS_reconcil[Inconsistency == 1, sum(N)],
                           ARS_reconcil[StartUpdated == 1, sum(N)],
                           ARS_reconcil[INSUF_QUALITY == 1, sum(N)],
                           ARS_reconcil[, sum(N)]),
                     
                     validated = c(5, 
                                   5, 
                                   5, 
                                   5, 
                                   5, 
                                   5, 
                                   5, 
                                   10),
                     
                     correct = c(DT_GGDE[accepted == TRUE, .N],
                                  DT_GGDS[accepted == TRUE, .N],
                                  DT_Discordant[accepted == TRUE, .N],
                                  DT_SlightlyDiscordant[accepted == TRUE, .N],
                                  DT_Inconsistency[accepted == TRUE, .N],
                                  DT_StartUpdated[accepted == TRUE, .N],
                                  DT_INSUF_QUALITY[accepted == TRUE, .N],
                                  DT_All[accepted == TRUE, .N]))


DT_All[, expected_incorrect := N - round(correct/validated *N, 0)]
DT_All[, incorrect := validated - correct]
DT_All_chr <- DT_All[, N := as.character(N)][N==0, N:= "<35"]
#DT_All_chr[, incorrect := paste0(not_correctly_classified, "/", validated)]
paged_table(DT_All_chr[, .(variable, validated, incorrect, total = N, expected_incorrect)])
```
## Start / End Difference

```{r valid_res_all, message=FALSE, warning=FALSE}
ARS_valid[pregnancy_start_date_difference == "n.a. (see comment)", pregnancy_start_date_difference := ""]
ARS_valid[pregnancy_end_date_difference == "n.a. (see comment)", pregnancy_end_date_difference := ""]

DT_cor_start <- ARS_valid[tolower(pregnancy_start_date_correct) %in% c('no', 'n', 'unk') & pregnancy_start_date_difference == "", pregnancy_start_date_difference := "not specified"]
DT_cor_end <- ARS_valid[tolower(pregnancy_end_date_correct) %in% c('no', 'n', 'unk') & pregnancy_end_date_difference == "", pregnancy_end_date_difference := "not specified"]

DT_cor_start <- DT_cor_start[sample == "pregnancy_splitted", sample := "All"]
DT_cor_start <- DT_cor_start[sample == "All" | sample == "pregnancy_splitted", .N, .(sample, pregnancy_start_date_difference)]
setnames(DT_cor_start, "sample", "Variable")
setnames(DT_cor_start, "pregnancy_start_date_difference", "difference")
tmp3_agg_2 <- tmp3_agg[Variable %in% c("Concordant", "pregnancy_splitted"), Variable := "All"]

DT_cor_start <- merge(DT_cor_start, tmp3_agg_2, all.x = T, by = c("Variable"))
DT_cor_start <- DT_cor_start[, perc_strata := N.x/15 * 100]
DT_cor_start <- DT_cor_start[Variable == "All", Variable := "Start Difference"]




DT_cor_end <- DT_cor_end[sample == "pregnancy_splitted", sample := "All"]
DT_cor_end <- DT_cor_end[sample == "All" | sample == "pregnancy_splitted", .N, .(sample, pregnancy_end_date_difference)]
setnames(DT_cor_end, "sample", "Variable")
setnames(DT_cor_end, "pregnancy_end_date_difference", "difference")
tmp3_agg_2 <- tmp3_agg[Variable %in% c("Concordant", "pregnancy_splitted"), Variable := "All"]

DT_cor_end <- merge(DT_cor_end, tmp3_agg_2, all.x = T, by = c("Variable"))
DT_cor_end <- DT_cor_end[, perc_strata := N.x/15 * 100]
DT_cor_end <- DT_cor_end[Variable == "All", Variable := "End Difference"]

DT_cor <- rbind(DT_cor_start, DT_cor_end)



DT_cor <- DT_cor[difference == "", difference :="1. 0 days"]
DT_cor <- DT_cor[difference == 1| difference == 5, difference := "2. days < 5 "]
DT_cor <- DT_cor[difference == 2| difference == 6, difference := "3. 5 < days <= 30"]
DT_cor <- DT_cor[difference == 3| difference == 7, difference := "4. 30 < days <= 90"]
DT_cor <- DT_cor[difference == 4| difference == 8, difference := "5. days > 90"]
DT_cor <- DT_cor[difference == "not specified", difference := "6. not specified"]


plt <- ggplot(DT_cor, aes(x = Variable, y =perc_strata, fill = difference)) +
  geom_col()+
  scale_fill_manual(values = c("1. 0 days" = "#69B34C", 
                               "2. days < 5 " = "#ACB334", 
                               "3. 5 < days <= 30" = "#FAB733", 
                               "4. 30 < days <= 90" = "#FF4E11", 
                               "5. days > 90"="#FF0D0D",
                               "6. not specified" = "grey")) +
  #guides(fill = guide_legend(title = "")) +
  xlab("")+
  ylab("")+
  theme_bw()+
  theme(text = element_text(family = "serif"), axis.text.x = element_text(angle = 45))

plt <- ggplotly(plt)
plt
```

#### With error on start

```{r valid_res_18, fig.height=4, fig.width=4, message=FALSE, warning=FALSE}
DT_start <- ARS_valid[tolower(pregnancy_start_date_correct) %in% c('no', 'n', 'unk') & pregnancy_start_date_difference == "", pregnancy_start_date_difference := "not specified"]
DT_start <- DT_start[sample != "All" & sample != "StartUpdated" & sample != "pregnancy_splitted", .N, .(sample, pregnancy_start_date_difference)]
setnames(DT_start, "sample", "Variable")
DT_start[Variable == "GG:Discordantstart", Variable := "GGDE"]
DT_start[Variable == "GG:DiscordantStart", Variable := "GGDS"]
DT_start[Variable == "insufficient_quality", Variable := "INSUF_QUALITY"]
DT_start[Variable == "StartUpdated", Variable := "INSUF_QUALITY"]


DT_start <- merge(DT_start, tmp3_agg, all.x = T, by = c("Variable"))
DT_start <- DT_start[, perc_strata := N.x/5 * percentage]

DT_start <- DT_start[pregnancy_start_date_difference == "", pregnancy_start_date_difference :="1. 0 days"]
DT_start <- DT_start[pregnancy_start_date_difference == 1| pregnancy_start_date_difference == 5, pregnancy_start_date_difference := "2. days < 5 "]
DT_start <- DT_start[pregnancy_start_date_difference == 2| pregnancy_start_date_difference == 6, pregnancy_start_date_difference := "3. 5 < days <= 30"]
DT_start <- DT_start[pregnancy_start_date_difference == 3| pregnancy_start_date_difference == 7, pregnancy_start_date_difference := "4. 30 < days <= 90"]
DT_start <- DT_start[pregnancy_start_date_difference == 4| pregnancy_start_date_difference == 8, pregnancy_start_date_difference := "5. days > 90"]
DT_start <- DT_start[pregnancy_start_date_difference == "not specified", pregnancy_start_date_difference := "6. not specified"]

plt <- ggplot(DT_start, aes(x = Variable, y =perc_strata, fill = pregnancy_start_date_difference)) +
  geom_col()+
  scale_fill_manual(values = c("1. 0 days" = "#69B34C", 
                               "2. days < 5 " = "#ACB334", 
                               "3. 5 < days <= 30" = "#FAB733", 
                               "4. 30 < days <= 90" = "#FF4E11", 
                               "5. days > 90"="#FF0D0D",
                               "6. not specified" = "grey")) +
  guides(fill = guide_legend(title = "")) +
  xlab("")+
  ylab("")+
  theme_bw()+
  theme(text = element_text(family = "serif"), axis.text.x = element_text(angle = 45))

plt <- ggplotly(plt)
plt
```

#### With error on end

```{r valid_res_19, fig.height=4, fig.width=4}
#tmp3_agg
DT_end <- ARS_valid[tolower(pregnancy_end_date_correct) %in% c('no', 'n', 'unk') & pregnancy_end_date_difference == "", pregnancy_end_date_difference := "not specified"]
DT_end <- DT_end[sample != "All" & sample != "StartUpdated" & sample != "pregnancy_splitted", .N, .(sample, pregnancy_end_date_difference)]
setnames(DT_end, "sample", "Variable")
DT_end[Variable == "GG:DiscordantEnd", Variable := "GGDE"]
DT_end[Variable == "GG:DiscordantStart", Variable := "GGDS"]
DT_end[Variable == "insufficient_quality", Variable := "INSUF_QUALITY"]
DT_end[Variable == "StartUpdated", Variable := "INSUF_QUALITY"]


DT_end <- merge(DT_end, tmp3_agg, all.x = T, by = c("Variable"))
DT_end <- DT_end[, perc_strata := N.x/5 * percentage]

DT_end <- DT_end[pregnancy_end_date_difference == "", pregnancy_end_date_difference :="1. 0 days"]
DT_end <- DT_end[pregnancy_end_date_difference == "1"| pregnancy_end_date_difference == "5", pregnancy_end_date_difference := "2. days < 5 "]
DT_end <- DT_end[pregnancy_end_date_difference == "2"| pregnancy_end_date_difference == "6", pregnancy_end_date_difference := "3. 5 < days <= 30"]
DT_end <- DT_end[pregnancy_end_date_difference == "3"| pregnancy_end_date_difference == "7", pregnancy_end_date_difference := "4. 30 < days <= 90"]
DT_end <- DT_end[pregnancy_end_date_difference == "4"| pregnancy_end_date_difference == "8", pregnancy_end_date_difference := "5. days > 90"]
DT_end <- DT_end[pregnancy_end_date_difference == "not specified", pregnancy_end_date_difference := "6. not specified"]

plt <- ggplot(DT_end, aes(x = Variable, y =perc_strata, fill = pregnancy_end_date_difference)) +
  geom_col()+
  scale_fill_manual(values = c("1. 0 days" = "#69B34C", 
                               "2. days < 5 " = "#ACB334", 
                               "3. 5 < days <= 30" = "#FAB733", 
                               "4. 30 < days <= 90" = "#FF4E11", 
                               "5. days > 90"="#FF0D0D",
                               "6. not specified" = "grey")) +
  guides(fill = guide_legend(title = "")) +
  xlab("")+
  ylab("")+
  theme_bw()+
  theme(text = element_text(family = "serif"), axis.text.x = element_text(angle = 45))

plt <- ggplotly(plt)
plt
```


#### With record belonging to multiple pregnancies

```{r valid_res_20, fig.height=4, fig.width=4}
#tmp3_agg
DT_rec <- ARS_valid[tolower(records_belong_to_multiple_pregnancy) %in% c("", "n", "no", "unk") , records_belong_to_multiple_pregnancy := "no"]
DT_rec[tolower(records_belong_to_multiple_pregnancy) %in% c("y", "yes") , records_belong_to_multiple_pregnancy := "yes"] 

DT_rec <- DT_rec[sample != "All" & sample != "StartUpdated" & sample != "pregnancy_splitted", .N, .(sample, records_belong_to_multiple_pregnancy)]
setnames(DT_rec, "sample", "Variable")
DT_rec[Variable == "GG:DiscordantEnd", Variable := "GGDE"]
DT_rec[Variable == "GG:DiscordantStart", Variable := "GGDS"]
DT_rec[Variable == "insufficient_quality", Variable := "INSUF_QUALITY"]
DT_rec[Variable == "StartUpdated", Variable := "INSUF_QUALITY"]


DT_rec <- merge(DT_rec, tmp3_agg, all.x = T, by = c("Variable"))

DT_rec <- DT_rec[, perc_strata := N.x/5 * percentage]


plt <- ggplot(DT_rec, aes(x = Variable, y =perc_strata, fill = records_belong_to_multiple_pregnancy)) +
  geom_col()+
  scale_fill_manual(values = c("no" = "#69B34C", 
                               "yes"="#FF0D0D")) +
  guides(fill = guide_legend(title = "")) +
  xlab("")+
  ylab("")+
  theme_bw()+
  theme(text = element_text(family = "serif"), axis.text.x = element_text(angle = 45))

plt <- ggplotly(plt)
plt
```
