---
title: "Verification report"
output: 
  html_document:
    theme: united
    toc: TRUE
    toc_float: TRUE
date: ""
params:
  sample_validated: NULL
  DT_recon: NULL
---

```{css, echo = FALSE}
h1 {color: #ed008c}
h2 {color: #00adef}
h3 {color: #6ccff6}
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {background-color: #00adef; border-color: #00adef}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

if (!require("rmarkdown")) install.packages("rmarkdown")
library(rmarkdown )
if (!require("ggplot2")) install.packages("ggplot2")
library(ggplot2 )
if (!require("ggthemes")) install.packages("ggthemes")
library(ggthemes)
if (!require("ggrepel")) install.packages("ggrepel")
library(ggrepel)
if (!require("plotly")) install.packages("plotly")
library(plotly)
if (!require("DT")) install.packages("DT")
library(DT)
if (!require("magrittr")) install.packages("magrittr")
library(magrittr)
if (!require("multipanelfigure")) install.packages("multipanelfigure")
library(multipanelfigure)

`%notin%` <- Negate(`%in%`)

sample_validated = copy(params$sample_validated)
DT_recon = copy(params$DT_recon)
```


## Record concordance

For each pregnancy, start, end, and type of end are defined by information obtained from multiple records retrieved from different sources. When records carry different information, the algorithm selects the highest quality (in accordance with the hierarchy) and saves the results of the process.
Records of the same pregnancy can be:

- concordant: equal start and end dates;

- slightly discordant: start and end date different by no more than 7 days;

- discordant: start and end date different more than 7 days 


The next graph shows the percentage of pregnancies divided by highest quality color and stratified by concordance variables.


```{r reconciliation}
DT_recon[N == "<5", N := 0][, N := as.integer(N)]
total_n_of_pregnancy <- DT_recon[, sum(N)]
DT_recon <- DT_recon[, tot := sum(N)][, percentage := round((N/tot)*100, 4)]
DT_recon[, color := str_split(strata, "_")[[1]][1], strata]
DT_recon[strata == "Yellow_SlightlyDiscordant", strata := "Yellow_CP_SlightlyDiscordant"]
plt <- ggplot(DT_recon, aes(x = color, y =percentage, fill = strata)) +
  geom_col()+
  scale_fill_manual(values = c("Green_Concordant" = "#69B34C", 
                               "Green_Discordant" = "#ACB334", 
                               "Yellow_Concordant" = "goldenrod1", 
                               "Yellow_CP_SlightlyDiscordant" = "goldenrod", 
                               "Yellow_Discordant"="gold4",
                               "Blue" = "deepskyblue3",
                               "Red" = "#FF0D0D")) +
  #guides(fill = guide_legend(title = "")) +
  xlab("")+
  ylab("")+
  theme_bw()+
  theme(text = element_text(family = "serif"))

plt <- ggplotly(plt)
plt  
  
datatable(DT_recon[, -c("color")])

```

---

## Expected pregnancies 

The following section shows the expected percentage of pregnancies with incorrect start, end and type of end. It also shows the expected percentage of pregnancies composed of records actually belonging to different pregnancies.

### Expected difference in pregnancy start date

The following graph shows the expected percentage of pregnancies with a different start date from that generated by the algorithm. 
The percentages are calculated taking into account the verification and the size of the sampling strata.

```{r exp_start}
DT_cor <- copy(sample_validated)
DT_strata <- DT_recon[, tot_strata := sum(N), color]
DT_strata <- DT_strata[, perc_strata_col := round(N/tot_strata *100 , 4)]
DT_strata <- DT_strata[strata== "Yellow_CP_SlightlyDiscordant", strata := "Yellow_SlightlyDiscordant"]
setnames(DT_strata, "strata", "sample")


DT_cor <- DT_cor[, pregnancy_start_date_difference := as.character(pregnancy_start_date_difference)]

DT_strata[, color := str_split(sample, "_")[[1]][1], sample]

DT_cor <- DT_cor[pregnancy_start_date_difference == "" | is.na(pregnancy_start_date_difference), pregnancy_start_date_difference :="1. 0 days"]
DT_cor <- DT_cor[pregnancy_start_date_difference == 1| pregnancy_start_date_difference == 5, pregnancy_start_date_difference := "2. days < 5 "]
DT_cor <- DT_cor[pregnancy_start_date_difference == 2| pregnancy_start_date_difference == 6, pregnancy_start_date_difference := "3. 5 < days <= 30"]
DT_cor <- DT_cor[pregnancy_start_date_difference == 3| pregnancy_start_date_difference == 7, pregnancy_start_date_difference := "4. 30 < days <= 90"]
DT_cor <- DT_cor[pregnancy_start_date_difference == 4| pregnancy_start_date_difference == 8, pregnancy_start_date_difference := "5. days > 90"]
DT_cor <- DT_cor[pregnancy_start_date_difference == "not specified", pregnancy_start_date_difference := "6. not specified"]
DT_cor[, color := str_split(sample, "_")[[1]][1], sample]

DT_start <-  DT_cor[, .N, by = c("pregnancy_start_date_difference", "sample", "color")]

n_valid <- DT_cor[, .(N_validated = .N), sample]

DT_start <- merge(DT_start, DT_strata[, .(perc_strata_col, sample, percentage)], by = c("sample"), all.x = TRUE)
DT_start <- merge(DT_start, n_valid, by = c("sample"), all.x = TRUE)

DT_start[, y := N / N_validated * perc_strata_col]
DT_plt <- DT_start[, .(y =sum(y)), by = c("color", "pregnancy_start_date_difference")]


DT_start[, y_pie := N/N_validated *percentage]
DT_pie <- DT_start[, .(y_pie =sum(y_pie)), by = c("pregnancy_start_date_difference")]

df2 <- DT_pie %>% 
  mutate(csum = rev(cumsum(rev(y_pie))), 
         pos = y_pie/2 + lead(csum, 1),
         pos = if_else(is.na(pos), y_pie/2, pos))
df2[, y_pie:= round(y_pie, 4)]
ggplot(df2, aes(x = "" , y = y_pie, fill = fct_inorder(as.factor(pregnancy_start_date_difference)))) +
  geom_col(width = 1 , col = "white") +
  coord_polar(theta = "y", start = pi*1.5) +
  geom_label_repel(aes(y = pos, label = paste0(y_pie, "%")),
                   size = 4.5, nudge_x = 1,  show.legend = FALSE) + #col = "gray",
    scale_fill_manual(values = c("1. 0 days" = "slategray1", 
                               "2. days < 5 " = "slategray2", 
                               "3. 5 < days <= 30" = "slategray3", 
                               "4. 30 < days <= 90" = "slategray4", 
                               "5. days > 90"="slategrey",
                               
                               "6. not specified" = "grey30")) +
  guides(fill = guide_legend(title = "Group")) +
  theme_void()+
  theme(text = element_text(family = "serif"))





```

The following graph is stratified by color quality.

```{r exp_start_plt_strata}
plt <- ggplot(DT_plt, aes(x = color, y = y, fill = pregnancy_start_date_difference)) +
  geom_col()+
  scale_fill_manual(values = c("1. 0 days" = "slategray1", 
                               "2. days < 5 " = "slategray2", 
                               "3. 5 < days <= 30" = "slategray3", 
                               "4. 30 < days <= 90" = "slategray4", 
                               "5. days > 90"="slategrey",
                               
                               "6. not specified" = "grey30")) +
  #guides(fill = guide_legend(title = "")) +
  xlab("")+
  ylab("")+
  theme_bw()+
  theme(text = element_text(family = "serif"), axis.text.x = element_text(angle = 45))

plt <- ggplotly(plt)
plt
```




### Expected difference in pregnancy end date

The following graph shows the expected percentage of pregnancies with a different end date from that generated by the algorithm. 
The percentages are calculated taking into account the verification and the size of the sampling strata.
```{r exp_end}
DT_cor <- copy(sample_validated)

DT_cor <- DT_cor[, pregnancy_end_date_difference := as.character(pregnancy_end_date_difference)]

DT_strata[, color := str_split(sample, "_")[[1]][1], sample]

DT_cor <- DT_cor[pregnancy_end_date_difference == "" | is.na(pregnancy_end_date_difference), pregnancy_end_date_difference :="1. 0 days"]
DT_cor <- DT_cor[pregnancy_end_date_difference == 1| pregnancy_end_date_difference == 5, pregnancy_end_date_difference := "2. days < 5 "]
DT_cor <- DT_cor[pregnancy_end_date_difference == 2| pregnancy_end_date_difference == 6, pregnancy_end_date_difference := "3. 5 < days <= 30"]
DT_cor <- DT_cor[pregnancy_end_date_difference == 3| pregnancy_end_date_difference == 7, pregnancy_end_date_difference := "4. 30 < days <= 90"]
DT_cor <- DT_cor[pregnancy_end_date_difference == 4| pregnancy_end_date_difference == 8, pregnancy_end_date_difference := "5. days > 90"]
DT_cor <- DT_cor[pregnancy_end_date_difference == "not specified", pregnancy_end_date_difference := "6. not specified"]
DT_cor[, color := str_split(sample, "_")[[1]][1], sample]

DT_end <-  DT_cor[, .N, by = c("pregnancy_end_date_difference", "sample", "color")]

n_valid <- DT_cor[, .(N_validated = .N), sample]

DT_end <- merge(DT_end, DT_strata[, .(percentage, perc_strata_col, sample)], by = c("sample"), all.x = TRUE)
DT_end <- merge(DT_end, n_valid, by = c("sample"), all.x = TRUE)

DT_end[, y := N / N_validated * perc_strata_col]
DT_plt <- DT_end[, .(y =sum(y)), by = c("color", "pregnancy_end_date_difference")]








DT_end[, y_pie := N/N_validated *percentage]
DT_pie <- DT_end[, .(y_pie =sum(y_pie)), by = c("pregnancy_end_date_difference")]

df2 <- DT_pie %>% 
  mutate(csum = rev(cumsum(rev(y_pie))), 
         pos = y_pie/2 + lead(csum, 1),
         pos = if_else(is.na(pos), y_pie/2, pos))
df2[, y_pie:= round(y_pie, 4)]

ggplot(df2, aes(x = "" , y = y_pie, fill = fct_inorder(as.factor(pregnancy_end_date_difference)))) +
  geom_col(width = 1 , col = "white") +
  coord_polar(theta = "y", start = pi*1.5) +
  geom_label_repel(aes(y = pos, label = paste0(y_pie, "%")),
                   size = 4.5, nudge_x = 1,  show.legend = FALSE) + #col = "gray",
    scale_fill_manual(values = c("1. 0 days" = "slategray1", 
                               "2. days < 5 " = "slategray2", 
                               "3. 5 < days <= 30" = "slategray3", 
                               "4. 30 < days <= 90" = "slategray4", 
                               "5. days > 90"="slategrey",
                               
                               "6. not specified" = "grey30")) +
  guides(fill = guide_legend(title = "Group")) +
  theme_void()+
  theme(text = element_text(family = "serif"))





```

The following graph is stratified by color quality.

```{r exp_end_plt_strata}
plt <- ggplot(DT_plt, aes(x = color, y = y, fill = pregnancy_end_date_difference)) +
  geom_col()+
  scale_fill_manual(values = c("1. 0 days" = "slategray1", 
                               "2. days < 5 " = "slategray2", 
                               "3. 5 < days <= 30" = "slategray3", 
                               "4. 30 < days <= 90" = "slategray4", 
                               "5. days > 90"="slategrey",
                               
                               "6. not specified" = "grey30")) +
  #guides(fill = guide_legend(title = "")) +
  xlab("")+
  ylab("")+
  theme_bw()+
  theme(text = element_text(family = "serif"), axis.text.x = element_text(angle = 45))

plt <- ggplotly(plt)
plt
```


### Expected pregnancy with wrong type of end

The following graph shows the expected percentage of pregnancies with a different type of end from that generated by the algorithm. 
The percentages are calculated taking into account the verification and the size of the sampling strata.

```{r exp_type}
DT_cor <- copy(sample_validated)

DT_cor <- DT_cor[, pregnancy_end_date_difference := as.character(pregnancy_end_date_difference)]

DT_strata[, color := str_split(sample, "_")[[1]][1], sample]

DT_cor <- DT_cor[type_of_pregnancy_end_correct == "" | 
                   is.na(type_of_pregnancy_end_correct) |
                   tolower(type_of_pregnancy_end_correct) == "yes" |
                   tolower(type_of_pregnancy_end_correct) == "y" , 
                 type_of_pregnancy_end_correct :="Correct"]

DT_cor <- DT_cor[tolower(type_of_pregnancy_end_correct) == "no" |
                   tolower(type_of_pregnancy_end_correct) == "n" , 
                 type_of_pregnancy_end_correct :="Incorrect"]

DT_cor <- DT_cor[type_of_pregnancy_end_correct != "Incorrect" &
                   type_of_pregnancy_end_correct != "Correct" , 
                 type_of_pregnancy_end_correct :="Not known"]

DT_cor[, color := str_split(sample, "_")[[1]][1], sample]

DT_type <-  DT_cor[, .N, by = c("type_of_pregnancy_end_correct", "sample", "color")]

n_valid <- DT_cor[, .(N_validated = .N), sample]

DT_type <- merge(DT_type, DT_strata[, .(percentage, perc_strata_col, sample)], by = c("sample"), all.x = TRUE)
DT_type <- merge(DT_type, n_valid, by = c("sample"), all.x = TRUE)

DT_type[, y := N / N_validated * perc_strata_col]
DT_plt <- DT_type[, .(y =sum(y)), by = c("color", "type_of_pregnancy_end_correct")]








DT_type[, y_pie := N/N_validated *percentage]
DT_pie <- DT_type[, .(y_pie =sum(y_pie)), by = c("type_of_pregnancy_end_correct")]

df2 <- DT_pie %>% 
  mutate(csum = rev(cumsum(rev(y_pie))), 
         pos = y_pie/2 + lead(csum, 1),
         pos = if_else(is.na(pos), y_pie/2, pos))
df2[, y_pie:= round(y_pie, 4)]
df2[, y_pie:= round(y_pie, 4)]

ggplot(df2, aes(x = "" , y = y_pie, fill = fct_inorder(as.factor(type_of_pregnancy_end_correct)))) +
  geom_col(width = 1 , col = "white") +
  coord_polar(theta = "y", start = pi*1.5) +
  geom_label_repel(aes(y = pos, label = paste0(y_pie, "%")),
                   size = 4.5, nudge_x = 1,  show.legend = FALSE) + 
    scale_fill_manual(values = c("Correct" = "darkslategray3", 
                               "Incorrect" = "firebrick", 
                               "Not known" = "gray")) +
  guides(fill = guide_legend(title = "Type of end")) +
  theme_void()+
  theme(text = element_text(family = "serif"))





```

The following graph is stratified by color quality.

```{r exp_type_plt_strata}
plt <- ggplot(DT_plt, aes(x = color, y = y, fill = type_of_pregnancy_end_correct)) +
  geom_col()+
  scale_fill_manual(values = c("Correct" = "darkslategray3", 
                               "Incorrect" = "firebrick", 
                               "Not known" = "gray")) +
  guides(fill = guide_legend(title = "Type of end")) +
  xlab("")+
  ylab("")+
  theme_bw()+
  theme(text = element_text(family = "serif"), axis.text.x = element_text(angle = 45))

plt <- ggplotly(plt)
plt
```



### Expected pregnancy with records belonging to multiple pregnancies

The following graph shows the expected percentage of pregnancies composed of records belonging to multiple pregnancies. 
The percentages are calculated taking into account the verification and the size of the sampling strata.

```{r exp_belong}
DT_cor <- copy(sample_validated)
DT_strata[, color := str_split(sample, "_")[[1]][1], sample]

DT_cor <- DT_cor[records_belong_to_multiple_pregnancy == "" | 
                   is.na(records_belong_to_multiple_pregnancy) |
                   tolower(records_belong_to_multiple_pregnancy) == "no" |
                   tolower(records_belong_to_multiple_pregnancy) == "n" , 
                 records_belong_to_multiple_pregnancy :="No"]

DT_cor <- DT_cor[tolower(records_belong_to_multiple_pregnancy) == "yes" |
                   tolower(records_belong_to_multiple_pregnancy) == "y" , 
                 records_belong_to_multiple_pregnancy :="Yes"]

DT_cor <- DT_cor[records_belong_to_multiple_pregnancy != "No" &
                   records_belong_to_multiple_pregnancy != "Yes" , 
                 records_belong_to_multiple_pregnancy :="Not known"]

DT_cor[, color := str_split(sample, "_")[[1]][1], sample]

DT_belong <-  DT_cor[, .N, by = c("records_belong_to_multiple_pregnancy", "sample", "color")]

n_valid <- DT_cor[, .(N_validated = .N), sample]

DT_belong <- merge(DT_belong, DT_strata[, .(percentage, perc_strata_col, sample)], by = c("sample"), all.x = TRUE)
DT_belong <- merge(DT_belong, n_valid, by = c("sample"), all.x = TRUE)

DT_belong[, y := N / N_validated * perc_strata_col]
DT_plt <- DT_belong[, .(y =sum(y)), by = c("color", "records_belong_to_multiple_pregnancy")]








DT_belong[, y_pie := N/N_validated *percentage]
DT_pie <- DT_belong[, .(y_pie =sum(y_pie)), by = c("records_belong_to_multiple_pregnancy")]

df2 <- DT_pie %>% 
  mutate(csum = rev(cumsum(rev(y_pie))), 
         pos = y_pie/2 + lead(csum, 1),
         pos = if_else(is.na(pos), y_pie/2, pos))
df2[, y_pie:= round(y_pie, 4)]
df2[, y_pie:= round(y_pie, 4)]

ggplot(df2, aes(x = "" , y = y_pie, fill = fct_inorder(as.factor(records_belong_to_multiple_pregnancy)))) +
  geom_col(width = 1 , col = "white") +
  coord_polar(theta = "y", start = pi*1.5) +
  geom_label_repel(aes(y = pos, label = paste0(y_pie, "%")),
                   size = 4.5, nudge_x = 1,  show.legend = FALSE) + 
    scale_fill_manual(values = c("No" = "darkslategray3", 
                               "Yes" = "firebrick", 
                               "Not known" = "gray")) +
  guides(fill = guide_legend(title = "Record belong to multiple pregnancies")) +
  theme_void()+
  theme(text = element_text(family = "serif"))





```

The following graph is stratified by color quality.

```{r exp_belong_plt_strata}
plt <- ggplot(DT_plt, aes(x = color, y = y, fill = records_belong_to_multiple_pregnancy)) +
  geom_col()+
  scale_fill_manual(values = c("No" = "darkslategray3", 
                               "Yes" = "firebrick", 
                               "Not known" = "gray")) +
  guides(fill = guide_legend(title = "Record belong to multiple pregnancies")) +
  xlab("")+
  ylab("")+
  theme_bw()+
  theme(text = element_text(family = "serif"), axis.text.x = element_text(angle = 45))

plt <- ggplotly(plt)
plt
```


## Verification results

This section contains the results of the verification.

---

<br>

### Green concordant 


```{r green_con}
sample_validated = copy(params$sample_validated)
DT_recon = copy(params$DT_recon)

DT_recon[N == "<5", N := 0][, N := as.integer(N)]
total_n_of_pregnancy <- DT_recon[, sum(N)]
DT_recon <- DT_recon[, tot := sum(N)][, percentage := round((N/tot)*100, 4)]
DT_recon[, color := str_split(strata, "_")[[1]][1], strata]
DT_recon[strata == "Yellow_SlightlyDiscordant", strata := "Yellow_CP_SlightlyDiscordant"]

ntmp_validated <- 0
if("Green_Concordant" %in% unique(DT_recon$strata)){
  ntmp <- DT_recon[strata == "Green_Concordant", N]
  ntmp_validated <- sample_validated[sample == "Green_Concordant", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " have concordant green records." )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) with concordant green records on the end date on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`


```{r DT_GC}
if(ntmp_validated >= 5){
  DT_GC <- sample_validated[sample == "Green_Concordant"]
  paged_table(DT_GC[,-c("algorithm_for_reconciliation", "sample", "description")])
}


```


---

<br>

### Green disconcordant 


```{r green_disconcordant}
ntmp_validated <- 0
if("Green_Discordant" %in% unique(DT_recon$strata)){
  ntmp <- DT_recon[strata == "Green_Discordant", N]
  ntmp_validated <- sample_validated[sample == "Green_Discordant", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " have disconcordant green records." )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) with discordant green records on the end date on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`


```{r valid_res_2}
if(ntmp_validated >= 5){
  DT_GD <- sample_validated[sample == "Green_Discordant"]

  paged_table(DT_GD[,-c("algorithm_for_reconciliation", "sample", "description")])
}


```



---

<br>

### Yellow concordant 


```{r Yellow_con}
ntmp_validated <- 0
if("Yellow_Concordant" %in% unique(DT_recon$strata)){
  ntmp <- DT_recon[strata == "Yellow_Concordant", N]
  ntmp_validated <- sample_validated[sample == "Yellow_Concordant", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " have concordant Yellow records." )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) with concordant Yellow records on the end date on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`


```{r DT_YC}
if(ntmp_validated >= 5){
  DT_YC <- sample_validated[sample == "Yellow_Concordant"]
  paged_table(DT_YC[,-c("algorithm_for_reconciliation", "sample", "description")])
}


```


---

<br>

### Yellow slightly discordant 


```{r Yellow_slightly}
ntmp_validated <- 0
if("Yellow_Concordant" %in% unique(DT_recon$strata)){
  ntmp <- DT_recon[strata == "Yellow_CP_SlightlyDiscordant", N]
  ntmp_validated <- sample_validated[sample == "Yellow_SlightlyDiscordant", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " have slightly discordant Yellow records." )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) with slightly discordant Yellow records on the end date on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`


```{r DT_YS}
if(ntmp_validated >= 5){
  DT_YS <- sample_validated[sample == "Yellow_SlightlyDiscordant"]
  paged_table(DT_YS[,-c("algorithm_for_reconciliation", "sample", "description")])
}


```

---

<br>

### Yellow  discordant 


```{r Yellow_discordant}
ntmp_validated <- 0
if("Yellow_Discordant" %in% unique(DT_recon$strata)){
  ntmp <- DT_recon[strata == "Yellow_Discordant", N]
  ntmp_validated <- sample_validated[sample == "Yellow_Discordant", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " have  discordant Yellow records." )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) with  discordant Yellow records on the end date on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`


```{r DT_YD}
if(ntmp_validated >= 5){
  DT_YD <- sample_validated[sample == "Yellow_Discordant"]
  paged_table(DT_YD[,-c("algorithm_for_reconciliation", "sample", "description")])
}


```


---

<br>

### Blue 


```{r Blue}
ntmp_validated <- 0
if("Blue" %in% unique(DT_recon$strata)){
  ntmp <- DT_recon[strata == "Blue", N]
  ntmp_validated <- sample_validated[sample == "Blue", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " have  Blue records." )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) with Blue records on the end date on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`


```{r DT_B}
if(ntmp_validated >= 5){
  DT_B <- sample_validated[sample == "Blue"]
  paged_table(DT_B[,-c("algorithm_for_reconciliation", "sample", "description")])
}


```



---

<br>

### Red 


```{r Red}
ntmp_validated <- 0
if("Red" %in% unique(DT_recon$strata)){
  ntmp <- DT_recon[strata == "Red", N]
  ntmp_validated <- sample_validated[sample == "Red", .N]
  if(ntmp > 0){
    includ <- TRUE
  }else{
    includ <- FALSE
  }
}else{
  includ <- FALSE
}

if(includ){
  talk <- paste0( ntmp, " on ",  total_n_of_pregnancy, " have  Red records." )
}else{
  talk <- paste0("There less than 35 pregnancies (5 for each type of end) with Red records on the end date on ",  total_n_of_pregnancy,".")
}

if(ntmp_validated >= 5){
  talk <- paste0(talk, " 5 of those were sampled and validated.")
}

```


`r {talk}`


```{r DT_R}
if(ntmp_validated >= 5){
  DT_R <- sample_validated[sample == "Red"]
  paged_table(DT_R[,-c("algorithm_for_reconciliation", "sample", "description")])
}


```


